<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sultanate of Oman National Day ‚Äì Check-In</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root{
      --brand:#006400;--bg:#f7f7f7;--card:#fff;--text:#222;--muted:#666;
      --radius:14px;--shadow:0 8px 24px rgba(0,0,0,.08);
      --success:#1b7f1b;--error:#b00020;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      display:grid;place-items:start center;padding:24px
    }
    .card{width:100%;max-width:760px;background:var(--card);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:20px 20px 24px}
    header{text-align:center;padding:8px 12px 16px;
      border-bottom:2px solid var(--brand);margin-bottom:16px}
    header h1{margin:8px 0 0;font-size:clamp(20px,3.5vw,28px);color:var(--brand)}
    header p{margin:6px 0 0;color:var(--muted);font-weight:600}
    .flag{display:block;margin:0 auto 6px;height:40px;border-radius:6px;object-fit:cover}
    .controls{display:grid;grid-template-columns:1fr;gap:12px;margin:14px 0 10px}
    @media (min-width:560px){
      .controls{grid-template-columns:1.2fr auto auto;align-items:center}
    }
    select,button{border-radius:10px;border:1px solid #ddd;
      padding:10px 12px;font:inherit;background:#fff}
    button{cursor:pointer;border:none;color:#fff;background:var(--brand);
      transition:transform .07s ease,filter .2s ease}
    button.secondary{background:#2f6f2f}
    button:disabled{opacity:.55;cursor:not-allowed}
    button:active{transform:translateY(1px)}
    .hint{font-size:13px;color:var(--muted)}
    #reader-wrap{margin:14px auto 8px;width:100%;display:grid;place-items:center}
    #reader{width:100%;max-width:680px;aspect-ratio:1/1;background:#000;
      border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
    .status{margin-top:12px;padding:12px;border-radius:10px;font-size:15px;
      white-space:pre-line;background:#f0f6f0;color:var(--success);
      border:1px solid #d9ebd9}
    .status.error{background:#fdecec;color:var(--error);border:1px solid #f6caca}
    #guestInfo{margin-top:18px;text-align:center;font-size:16px;display:none}
    footer{margin-top:10px;text-align:center;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<main class="card" role="main" aria-label="National Day Check-In">
  <header>
    <img class="flag"
         src="https://www.fm.gov.om/wp-content/uploads/Flag_of_OmanMin-of-Info-800px-600x343.jpg"
         alt="Flag of the Sultanate of Oman"/>
    <h1>Scan Guest QR Code</h1>
    <p>Sultanate of Oman National Day 2025 ‚Äì Check-In</p>
  </header>

  <section class="controls" aria-label="Scanner Controls">
    <select id="cameraSelect"><option disabled selected>Choose camera‚Ä¶</option></select>
    <button id="startBtn" type="button">‚ñ∂ Start Scan</button>
    <button id="stopBtn" type="button" class="secondary" disabled>‚è∏ Stop</button>
    <div class="hint" style="grid-column:1/-1">
      Tip: allow camera access; best with the back camera.
    </div>
  </section>

  <div id="reader-wrap"><div id="reader"></div></div>

  <div id="status" class="status">Waiting to start‚Ä¶</div>

  <div id="guestInfo">
    <p id="guestDetails"></p>
    <button id="checkInBtn" style="display:none;">‚úÖ Check In</button>
  </div>

  <footer>¬© 2025 Embassy of the Sultanate of Oman ‚Äì Washington D.C.</footer>
</main>

<script>
/* ---------- Configuration ---------- */
// üîó Replace with your real Power Automate URLs
const getInfoUrl  = "https://defaulta4f4a348105d4206a9482fbe287c3d.e7.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/64a46e6d2a5647f1a50ca08f74ad1c50/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=McrYsVeN6dNaAuDm2UJswGM3pupLzIqOw_fGjjq3mmE";
const checkInUrl  = "https://defaulta4f4a348105d4206a9482fbe287c3d.e7.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/36be5d2104ea44b9bfe823690bed9fc1/triggers/manual/paths/invoke?api-version=1";

const statusEl   = document.getElementById("status");
const startBtn   = document.getElementById("startBtn");
const stopBtn    = document.getElementById("stopBtn");
const cameraSel  = document.getElementById("cameraSelect");
const guestBox   = document.getElementById("guestInfo");
const guestText  = document.getElementById("guestDetails");
const checkBtn   = document.getElementById("checkInBtn");

let html5Qr, isRunning=false, resizeTimer;

/* ---------- Helpers ---------- */
function setStatus(t,err=false){
  statusEl.textContent=t;
  statusEl.classList.toggle("error",!!err);
}
function parseGuestId(decoded){
  try{const u=new URL(decoded);return u.searchParams.get("id");}
  catch{return decoded.trim()||null;}
}

/* ---------- QR Scanner ---------- */
async function populateCameras(){
  try{
    const cams=await Html5Qrcode.getCameras();
    cameraSel.innerHTML='<option disabled selected>Choose camera‚Ä¶</option>';
    if(!cams.length){setStatus("‚ö†Ô∏è No cameras detected.",true);return;}
    for(const c of cams){
      const o=document.createElement("option");
      o.value=c.id;o.textContent=c.label||"Camera";
      cameraSel.appendChild(o);
    }
    cameraSel.selectedIndex=1;
  }catch{setStatus("‚ö†Ô∏è Unable to list cameras.",true);}
}
async function startScanner(){
  try{
    if(!html5Qr) html5Qr=new Html5Qrcode("reader",false);
    const id=cameraSel.value||(await Html5Qrcode.getCameras())[0]?.id;
    if(!id){setStatus("‚ö†Ô∏è Select a camera before starting.",true);return;}
    await html5Qr.start({deviceId:{exact:id}},
      {fps:12,qrbox:{width:320,height:320}},
      onScanSuccess,()=>{});
    isRunning=true;
    startBtn.disabled=true;stopBtn.disabled=false;cameraSel.disabled=true;
    setStatus("üì∑ Scanner running ‚Äì align QR code inside the square.");
  }catch(e){setStatus("‚ùå Cannot start scanner \n"+e.message,true);}
}
async function stopScanner(){
  if(html5Qr&&isRunning){try{await html5Qr.stop();await html5Qr.clear();}catch{}}
  isRunning=false;startBtn.disabled=false;stopBtn.disabled=true;cameraSel.disabled=false;
  setStatus("Scanner stopped. Press Start to resume.");
}

/* ---------- Power Automate Integration ---------- */
async function fetchGuestInfo(qrGuid){
  setStatus("üîç Fetching guest info‚Ä¶");
  try{
    const res = await fetch(getInfoUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: qrGuid })
    });

    if (!res.ok) throw new Error("Guest not found");

    const data = await res.json();

    // ‚úÖ Clean RSVP if SharePoint returned a Choice object
    const rsvp = (data && typeof data.RSVP === 'object') ? data.RSVP.Value : data.RSVP;

    // ‚úÖ Show guest info on the page
    guestText.innerHTML = `<b>Name:</b> ${data.Name}<br><b>RSVP:</b> ${rsvp || 'N/A'}`;
    guestBox.style.display = "block";

    // ‚úÖ Friendlier green status message (this is the line you asked about)
    setStatus(`‚úÖ Guest record found. Welcome, ${data.Name}!`);

    // Show the Check In button and wire it up
    checkBtn.style.display = "inline-block";
    checkBtn.onclick = () => checkInGuest(qrGuid);

  } catch (e) {
    setStatus("‚ùå " + e.message, true);
    guestBox.style.display = "none";
  }
}

async function checkInGuest(qrGuid){
  setStatus("‚è≥ Checking in‚Ä¶");
  try{
    const res=await fetch(checkInUrl,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({id:qrGuid})
    });
    if(!res.ok) throw new Error("Failed to check in");
    const data=await res.json();
    setStatus("‚úÖ Checked in at "+data.timestamp);
    checkBtn.style.display="none";
  }catch(e){setStatus("‚ùå "+e.message,true);}
}

/* ---------- On successful scan ---------- */
function onScanSuccess(decoded){
  const id=parseGuestId(decoded);
  if(!id){setStatus("‚ùå QR scanned but no ID found.",true);return;}
  stopScanner().finally(()=>fetchGuestInfo(id));
}

/* ---------- Listeners ---------- */
startBtn.addEventListener("click",startScanner);
stopBtn.addEventListener("click",stopScanner);
window.addEventListener("resize",()=>{
  if(!isRunning) return;
  clearTimeout(resizeTimer);
  resizeTimer=setTimeout(()=>{stopScanner().then(startScanner);},250);
});
(async()=>{
  if(location.protocol!=="https:")
    setStatus("‚ÑπÔ∏è Tip: Use HTTPS for camera access.");
  await populateCameras();
})();
</script>
</body>
</html>


