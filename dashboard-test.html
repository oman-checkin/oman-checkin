<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Oman National Day Check-In Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { color: #333; }
    .cards { display: flex; gap: 20px; margin-bottom: 20px; }
    .card {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 20px;
      flex: 1;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card h2 { margin: 0; font-size: 2em; color: #0078d4; }
    .card p { margin: 5px 0 0; color: #666; }
    input[type="text"] {
      padding: 8px;
      width: 300px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th { background: #f0f0f0; }
    tr:nth-child(even) { background: #f9f9f9; }
  </style>
</head>
<body>
  <h1>Oman National Day 2025 – Guest Check-In Dashboard</h1>

  <div class="cards">
    <div class="card">
      <h2 id="total">—</h2>
      <p>Total Guests</p>
    </div>
    <div class="card">
      <h2 id="checked">—</h2>
      <p>Checked In</p>
    </div>
    <div class="card">
      <h2 id="notChecked">—</h2>
      <p>Not Checked In</p>
    </div>
  </div>

  <input type="text" id="search" placeholder="Search by name or email..." />

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Email</th>
        <th>QR GUID</th>
        <th>Check-In Time</th>
      </tr>
    </thead>
    <tbody id="guestTable">
      <tr><td colspan="5">No guest detail data in JSON.</td></tr>
    </tbody>
  </table>

  <script>
    const DATA_URL = "https://raw.githubusercontent.com/oman-checkin/oman-checkin/main/checkin.json?_=" + Date.now();

    async function load() {
      try {
        const res = await fetch(DATA_URL + "&t=" + Date.now());
        if (!res.ok) throw new Error("Fetch failed");
        const data = await res.json();

        document.getElementById("total").textContent = data.total ?? 0;
        document.getElementById("checked").textContent = data.checked_in ?? 0;
        document.getElementById("notChecked").textContent = data.not_checked_in ?? 0;

        const guests = Array.isArray(data.guests) ? data.guests : [];
        const search = document.getElementById("search").value.toLowerCase();
        const tbody = document.getElementById("guestTable");
        tbody.innerHTML = "";

        const filtered = guests.filter(g =>
          (g.Name || "").toLowerCase().includes(search) ||
          (g.Email || "").toLowerCase().includes(search)
        );

        if (filtered.length === 0) {
          tbody.innerHTML = "<tr><td colspan='5'>No guest detail data.</td></tr>";
        } else {
          filtered.forEach((g, i) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${i + 1}</td>
              <td>${g.Name || ""}</td>
              <td>${g.Email || ""}</td>
              <td>${g.QR_GUID || ""}</td>
              <td>${g.CheckInTimestamp ? new Date(g.CheckInTimestamp).toLocaleString() : ""}</td>
            `;
            tbody.appendChild(row);
          });
        }

      } catch (err) {
        document.getElementById("guestTable").innerHTML = "<tr><td colspan='5'>Error loading data</td></tr>";
      }
    }

    document.getElementById("search").addEventListener("input", load);

    // refresh every 5 seconds
    setInterval(load, 5000);

    load();
  </script>
</body>
</html>
