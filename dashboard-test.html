<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Event Check-In Dashboard</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --p1:#667eea;--p2:#764ba2;
      --ok:#10b981;--warn:#ef4444;--ink:#333;--muted:#666;--bg:#f9f9f9;
      --card:#fff;--ring:#e0e0e0;--shadow:0 10px 30px rgba(0,0,0,.2)
    }
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,var(--p1) 0%,var(--p2) 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{text-align:center;color:#fff;margin-bottom:32px}
    .header h1{font-size:2.2rem;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.2)}
    .header p{opacity:.9}
    .controls,.guest-list,.stat-card{background:var(--card);border-radius:15px;box-shadow:var(--shadow)}
    .controls{padding:16px 20px;margin-bottom:20px}
    .controls-grid{display:grid;grid-template-columns:auto auto auto;gap:12px;align-items:end}
    .btn{padding:12px 16px;border:none;border-radius:8px;font-size:.95rem;font-weight:700;cursor:pointer;transition:transform .2s,box-shadow .2s;text-transform:uppercase;letter-spacing:.5px}
    .btn-primary{background:linear-gradient(135deg,var(--p1),var(--p2));color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}
    .btn-secondary{background:#6c757d;color:#fff}
    .btn-secondary:hover{transform:translateY(-2px);background:#5a6268}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none!important}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:20px}
    .stat-card{padding:24px;text-align:center;transition:transform .2s}
    .stat-card:hover{transform:translateY(-4px)}
    .stat-card .icon{font-size:2.6rem;margin-bottom:10px}
    .number{font-size:2.4rem;font-weight:800;margin-bottom:6px}
    .label{font-size:1rem;color:#666;text-transform:uppercase;letter-spacing:.8px}
    .total .icon,.total .number{color:var(--p1)}
    .checked-in .icon,.checked-in .number{color:var(--ok)}
    .not-checked .icon,.not-checked .number{color:var(--warn)}
    .guest-list{padding:20px}
    .guest-list h2{margin-bottom:12px;color:var(--ink);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .badge{background:var(--p1);color:#fff;padding:4px 12px;border-radius:999px;font-size:.85rem}
    .table-actions{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 16px}
    .search{flex:1;min-width:220px;padding:12px;border:2px solid var(--ring);border-radius:8px;font-size:1rem}
    .guest-table{width:100%;border-collapse:collapse}
    .guest-table thead{background:linear-gradient(135deg,var(--p1),var(--p2));color:#fff}
    th,td{padding:12px 10px;text-align:left}
    th{font-weight:700;text-transform:uppercase;font-size:.8rem;letter-spacing:.6px;user-select:none;cursor:pointer;white-space:nowrap}
    tbody tr{border-bottom:1px solid var(--ring);transition:background-color .15s}
    tbody tr:hover{background:#f8f9fa}
    .qr-code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#f0f0f0;padding:4px 8px;border-radius:6px;font-size:.85rem}
    .timestamp{color:var(--muted);font-size:.9rem;white-space:nowrap}
    .loading{text-align:center;padding:36px;color:#fff}
    .spinner{border:4px solid rgba(255,255,255,.35);border-top:4px solid #fff;border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite;margin:0 auto 12px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error{background:#fee;border:2px solid #fcc;color:#c33;padding:16px;border-radius:10px;margin-bottom:16px}
    .empty-state{text-align:center;padding:50px 12px;color:#999}
    .empty-state .icon{font-size:3.2rem;margin-bottom:12px;opacity:.5}
    .last-updated{text-align:center;color:#fff;margin-top:16px;font-size:.9rem;opacity:.85}
    .pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.35)}
    @media(max-width:900px){.controls-grid{grid-template-columns:1fr 1fr;grid-auto-rows:auto}}
    @media(max-width:680px){.controls-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container" role="main">
    <div class="header" aria-live="polite">
      <h1>üéâ Event Check-In Dashboard</h1>
      <p>Real-time monitoring of guest arrivals</p>
    </div>

    <div class="controls" aria-label="Controls">
      <div class="controls-grid">
        <button class="btn btn-primary" id="loadBtn" aria-label="Load Dashboard">Load</button>
        <button class="btn btn-secondary" id="refreshBtn" style="display:none" aria-label="Refresh Dashboard">Refresh</button>
        <button class="btn btn-secondary" id="exportBtn" style="display:none" aria-label="Export CSV">Export CSV</button>
      </div>

      <div style="display:flex; gap:12px; align-items:center; margin-top:12px; flex-wrap:wrap">
        <span class="pill">Auto-refresh:
          <label style="margin-left:8px; user-select:none">
            <input type="checkbox" id="autoToggle" checked />
            <span style="margin-left:6px">On (30s)</span>
          </label>
        </span>
        <span class="pill" id="timerPill" aria-live="polite">Next refresh in 30s</span>
      </div>
    </div>

    <div id="error" class="error" style="display:none"></div>

    <div id="loading" class="loading" style="display:none">
      <div class="spinner"></div>
      <p>Loading dashboard data‚Ä¶</p>
    </div>

    <div id="dashboard" style="display:none">
      <div class="stats-grid" role="region" aria-label="Summary statistics">
        <div class="stat-card total">
          <div class="icon">üë•</div>
          <div class="number" id="totalGuests">0</div>
          <div class="label">Total Guests</div>
        </div>
        <div class="stat-card checked-in">
          <div class="icon">‚úÖ</div>
          <div class="number" id="checkedInGuests">0</div>
          <div class="label">Checked In</div>
        </div>
        <div class="stat-card not-checked">
          <div class="icon">‚è≥</div>
          <div class="number" id="notCheckedGuests">0</div>
          <div class="label">Not Checked In</div>
        </div>
      </div>

      <div class="guest-list" role="region" aria-label="Checked-in guests">
        <h2>Checked-In Guests <span class="badge" id="guestCount">0</span></h2>

        <div class="table-actions">
          <input id="searchBox" class="search" type="text" placeholder="Search by name, email, or QR‚Ä¶" aria-label="Search guests" />
        </div>

        <div id="guestTableContainer"></div>
      </div>

      <div class="last-updated" id="lastUpdated"></div>
    </div>
  </div>

  <script>
    // üëá This is the file your Power Automate flow writes to
    const GITHUB_JSON_URL = "https://raw.githubusercontent.com/oman-checkin/oman-checkin/main/data/checkin.json";

    const $ = (id) => document.getElementById(id);
    const formatDT = (v) => {
      if (!v) return "N/A";
      try {
        const d = (v instanceof Date) ? v : new Date(v);
        if (isNaN(d)) return "N/A";
        return d.toLocaleString();
      } catch { return "N/A"; }
    };
    const getField = (obj, variants = []) => {
      for (const key of variants) {
        if (obj && Object.prototype.hasOwnProperty.call(obj, key) && obj[key] != null && obj[key] !== "") {
          return obj[key];
        }
      }
      const lowerKeys = Object.keys(obj || {}).reduce((map, k) => (map[k.toLowerCase()] = k, map), {});
      for (const v of variants) {
        const lk = v.toLowerCase();
        if (lowerKeys[lk] && obj[lowerKeys[lk]] != null && obj[lowerKeys[lk]] !== "") return obj[lowerKeys[lk]];
      }
      return undefined;
    };

    // Sorting state
    let sortState = { key: "CheckInTimestamp", dir: "desc" };
    let lastData = { summary: { total:0, checkedIn:0, notChecked:0 }, checkedIn: [] };
    let filteredRows = [];
    let tickHandle = null;

    $("loadBtn").addEventListener("click", () => loadDashboard());
    $("refreshBtn").addEventListener("click", () => loadDashboard(true));
    $("exportBtn").addEventListener("click", () => exportCSV());
    $("autoToggle").addEventListener("change", (e) => { if (e.target.checked) startTimer(); else stopTimer(); });
    $("searchBox").addEventListener("input", () => { applySearch(); renderTable(); });

    // start auto timer on page load
    (function init() {
      startTimer();
    })();

    async function loadDashboard(isRefresh=false) {
      toggleError(false);
      toggleDashboard(false);
      toggleLoading(true);

      try {
        // cache-buster so GitHub always gives latest
        const resp = await fetch(GITHUB_JSON_URL + "?_=" + Date.now());
        if (!resp.ok) {
          throw new Error("GitHub returned " + resp.status);
        }
        const raw = await resp.json();

        const normalized = normalizeData(raw);
        lastData = normalized;

        $("totalGuests").textContent = normalized.summary.total || 0;
        $("checkedInGuests").textContent = normalized.summary.checkedIn || 0;
        $("notCheckedGuests").textContent = normalized.summary.notChecked || 0;

        filteredRows = [...normalized.checkedIn];
        applySearch();
        renderTable();

        $("loading").style.display = "none";
        toggleDashboard(true);
        $("loadBtn").style.display = "none";
        $("refreshBtn").style.display = "inline-block";
        $("exportBtn").style.display = filteredRows.length ? "inline-block" : "none";
        $("lastUpdated").textContent = `Last updated: ${formatDT(new Date())}`;
      } catch (err) {
        $("loading").style.display = "none";
        showError(`Failed to load dashboard: ${err.message}`);
      }
    }

    function normalizeData(data) {
      if (!data || typeof data !== "object")
        return { summary: { total: 0, checkedIn: 0, notChecked: 0 }, checkedIn: [] };

      const summaryBlock = data.summary || {};
      let total = Number(summaryBlock.total) || 0;
      let checkedInTotal = Number(summaryBlock.checkedIn) || 0;
      let notChecked = Number(summaryBlock.notChecked) || 0;

      const checkedInArray = Array.isArray(data.checkedIn) ? data.checkedIn : [];

      if (!checkedInTotal) checkedInTotal = checkedInArray.length;
      if (!notChecked && total >= checkedInTotal) notChecked = total - checkedInTotal;

      const cleaned = checkedInArray.map(g => ({
        Name: g.Name || g.FullName || g.GuestName || "N/A",
        Email: g.Email || g.EmailAddress || "N/A",
        QR_GUID: g.QR_GUID || g.QRCode || g.QRId || "N/A",
        CheckInTimestamp: g.CheckInTimestamp ? new Date(g.CheckInTimestamp) : null
      }));

      if (!total && cleaned.length) total = cleaned.length;

      return {
        summary: { total, checkedIn: checkedInTotal, notChecked },
        checkedIn: cleaned
      };
    }

    function toggleLoading(on){ $("loading").style.display = on ? "block" : "none"; }
    function toggleDashboard(on){ $("dashboard").style.display = on ? "block" : "none"; }
    function toggleError(on){ $("error").style.display = on ? "block" : "none"; }
    function showError(msg){ const e=$("error"); e.textContent = msg; toggleError(true); }

    function applySearch() {
      const q = ($("searchBox").value || "").trim().toLowerCase();
      const rows = lastData.checkedIn || [];
      if (!q) { filteredRows = [...rows]; return; }
      filteredRows = rows.filter(r =>
        r.Name.toLowerCase().includes(q) ||
        r.Email.toLowerCase().includes(q) ||
        r.QR_GUID.toLowerCase().includes(q)
      );
    }

    function setSort(key) {
      const keyMap = { "#":"#", "Name":"Name", "Email":"Email", "QR Code":"QR_GUID", "Check-In Time":"CheckInTimestamp" };
      const field = keyMap[key] || "CheckInTimestamp";
      if (sortState.key === field) {
        sortState.dir = (sortState.dir === "asc" ? "desc" : "asc");
      } else {
        sortState.key = field;
        sortState.dir = (field === "CheckInTimestamp" ? "desc" : "asc");
      }
      renderTable();
    }

    function renderTable() {
      const el = $("guestTableContainer");
      if (!filteredRows.length) {
        el.innerHTML = `
          <div class="empty-state">
            <div class="icon">üìã</div>
            <h3>No checked-in guests yet</h3>
            <p>Guests will appear here once they check in.</p>
          </div>
        `;
        $("guestCount").textContent = "0";
        $("exportBtn").style.display = "none";
        return;
      }

      filteredRows.sort((a,b) => {
        let cmp = 0;
        switch (sortState.key) {
          case "Name": cmp = a.Name.localeCompare(b.Name); break;
          case "Email": cmp = a.Email.localeCompare(b.Email); break;
          case "QR_GUID": cmp = a.QR_GUID.localeCompare(b.QR_GUID); break;
          case "CheckInTimestamp":
            cmp = (a.CheckInTimestamp?.getTime()||0) - (b.CheckInTimestamp?.getTime()||0);
            break;
          default: cmp = 0;
        }
        return sortState.dir === "asc" ? cmp : -cmp;
      });

      const arrow = sortState.dir === "asc" ? "‚ñ≤" : "‚ñº";
      const th = (name, mapKey) =>
        `<th data-key="${name}" aria-sort="${sortState.key===mapKey ? sortState.dir : 'none'}">${name}${(sortState.key===mapKey)?` ${arrow}`:""}</th>`;

      let html = `
        <table class="guest-table">
          <thead>
            <tr>
              ${th("#","#")}
              ${th("Name","Name")}
              ${th("Email","Email")}
              ${th("QR Code","QR_GUID")}
              ${th("Check-In Time","CheckInTimestamp")}
            </tr>
          </thead>
          <tbody>
      `;

      filteredRows.forEach((g, i) => {
        html += `
          <tr>
            <td>${i+1}</td>
            <td><strong>${escapeHTML(g.Name)}</strong></td>
            <td>${escapeHTML(g.Email)}</td>
            <td><span class="qr-code" title="QR / GUID">${escapeHTML(g.QR_GUID)}</span></td>
            <td><span class="timestamp">${formatDT(g.CheckInTimestamp)}</span></td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      el.innerHTML = html;

      el.querySelectorAll("th").forEach(thEl => {
        thEl.addEventListener("click", () => setSort(thEl.getAttribute("data-key")));
      });

      $("guestCount").textContent = String(filteredRows.length);
      $("exportBtn").style.display = "inline-block";
    }

    function escapeHTML(s) {
      return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function exportCSV() {
      if (!filteredRows.length) return;
      const rows = filteredRows.map(r => ({
        Name: r.Name,
        Email: r.Email,
        QR_GUID: r.QR_GUID,
        CheckInTimestamp: r.CheckInTimestamp ? r.CheckInTimestamp.toISOString() : ""
      }));
      const header = Object.keys(rows[0]);
      const csv = [
        header.join(","),
        ...rows.map(r => header.map(k => csvCell(r[k])).join(","))
      ].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `checked-in-${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function csvCell(v) {
      const s = String(v ?? "");
      if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function startTimer() {
      stopTimer();
      let countdown = 30;
      $("timerPill").textContent = `Next refresh in ${countdown}s`;
      tickHandle = setInterval(async () => {
        if (!$("autoToggle").checked) return;
        countdown--;
        if (countdown > 0) {
          $("timerPill").textContent = `Next refresh in ${countdown}s`;
        } else {
          $("timerPill").textContent = `Refreshing‚Ä¶`;
          await loadDashboard(true);
          countdown = 30;
          $("timerPill").textContent = `Next refresh in ${countdown}s`;
        }
      }, 1000);
    }
    function stopTimer() {
      if (tickHandle) clearInterval(tickHandle);
      tickHandle = null;
      $("timerPill").textContent = `Auto-refresh paused`;
    }
  </script>
</body>
</html>
